{% extends 'base.html' %}

{% block body %}

<div id="map" class="map">
    <div class="container-photo">
        <div class="owl-carousel">
            <div class="item" style="width:250px"><h4>1</h4></div>
            <div class="item" style="width:100px"><h4>2</h4></div>
            <div class="item" style="width:500px"><h4>3</h4></div>
            <div class="item" style="width:100px"><h4>4</h4></div>
            <div class="item" style="width:50px"><h4>6</h4></div>
            <div class="item" style="width:250px"><h4>7</h4></div>
            <div class="item" style="width:120px"><h4>8</h4></div>
            <div class="item" style="width:420px"><h4>9</h4></div>
            <div class="item" style="width:120px"><h4>10</h4></div>
            <div class="item" style="width:300px"><h4>11</h4></div>
            <div class="item" style="width:450px"><h4>12</h4></div>
            <div class="item" style="width:220px"><h4>13</h4></div>
            <div class="item" style="width:150px"><h4>14</h4></div>
            <div class="item" style="width:600px"><h4>15</h4></div>
        </div>
    </div>
    
</div>

{% endblock %}

{% block style_head %}
    <link rel="stylesheet" href="{{ url_for('static', filename='ol/ol.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='owlcarousel/assets/owl.carousel.min.css')}}">
    <link rel="stylesheet" href="{{ url_for('static', filename='owlcarousel/assets/owl.theme.default.min.css')}}">
{% endblock style_head %}

{% block style_theme %}
    
    <style>
        #map, .map{
            width: 100%;
            height: 100vh;
        }
        .container-photo{
            bottom: 50px;
            position: absolute;
            display: none;
            width: auto;
            background: #FFF;
            z-index: 9999;
        }
        .container-photo.open{
            display: block;
        }
    </style>
{% endblock style_theme %}

{% block script_end %}
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha256-4+XzXVhsDmqanXGHaHvgh1gMQKX40OUvDEBTu8JcmNs=" crossorigin="anonymous"></script>
<script src="{{ url_for('static', filename='ol/ol.js') }}"></script>
<script src="{{ url_for('static', filename='owlcarousel/owl.carousel.min.js') }}"></script>
<script>
 let map, view;
 let mode = 'nearest_poi';
 let parser = new ol.format.GeoJSON()
 const transform = ol.proj.getTransform('EPSG:3857',"EPSG:4326")
    view = new ol.View({
        center: ol.proj.fromLonLat([106.8208828, -6.6169003]),
        zoom: 13
    });
    let vl_poi = new ol.layer.Vector({
        source: new ol.source.Vector()
    });
    
    let vl_admin = new ol.layer.Vector({
        source: new ol.source.Vector()
    });
    map = new ol.Map({
        target: 'map',
        view: view,
        layers: [
            new ol.layer.Tile({
                source: new ol.source.XYZ({
                    url: 'http://mt0.google.com/vt/lyrs=m&hl=en&x={x}&y={y}&z={z}'
                }
                )
            }),
            vl_admin,
            vl_poi
        ]
    });
    get_admin();

map.on('singleclick', onMapClick);

map.on('moveend', onMoveEnd);

async function get_bbox(minx, miny, maxx, maxy){
    const res = await axios.get(`${window.location.origin}/get_bbox`);
    const response = res.data;
    console.log(response);
}
async function get_poi(lat, lon){
    vl_poi.getSource().clear();
    const response = await axios.get(`${window.location.origin}/get_poi?lat=${lat}&lon=${lon}`);
    let res = response.data;
    let resdata = res.data;
    console.log(resdata);
    for(let i = 0; i < resdata.length; i++){
        const el = resdata[i];
        let props = { latitude: el.latitude, longitude: el.longitude }
        let feature = generate_point(props);
        vl_poi.getSource().addFeature(feature)
    }
    
}

async function get_admin(){
    const res = await axios.get(`${window.location.origin}/get_administrasi`)
    const response = res.data;
    const resdata = response.data;
    vl_admin.getSource().clear()
    for(let i=0;i < resdata.length; i++){
        const el = resdata[i];
        console.log(el)
        let features = parser.readFeatures(el.geojson);
        vl_admin.getSource().addFeatures(features);
    }
}

function generate_point(props = NULL) {
    const transform4326to3857 = ol.proj.getTransform("EPSG:4326", "EPSG:3857");
    let feature = new ol.Feature(props);
    const iconStyle = default_icon();
    feature.setStyle(iconStyle);
    if (props.longitude == null && props.latitude == null) {
        console.log("kordinat salah");
        return false;
    } else {
        const coordinate = transform4326to3857([
            parseFloat(props.longitude),
            parseFloat(props.latitude),
        ]);
        if (!isNaN(coordinate[0]) && !isNaN(coordinate[1])) {
            const geometry = new ol.geom.Point(coordinate);
            feature.setGeometry(geometry);
            return feature;
        }
    }

    return;
}

function change_mode(newmode){
    mode = newmode;
}

function default_icon() {
    return new ol.style.Style({
        image: new ol.style.Icon({
            anchor: [0.2, 32],
            anchorXUnits: "fraction",
            anchorYUnits: "pixels",
            src: "http://maps.gstatic.com/mapfiles/api-3/images/spotlight-poi2.png",
            scale: 0.7,
        }),
    });
}


function onMoveEnd(evt) {
    let map = evt.map;
    let extent = map.getView().calculateExtent(map.getSize());
    let bottomLeft = ol.proj.transform(ol.extent.getBottomLeft(extent),
        'EPSG:3857', 'EPSG:4326');
    let topRight = ol.proj.transform(ol.extent.getTopRight(extent),
        'EPSG:3857', 'EPSG:4326');
    get_bbox(wrapLon(bottomLeft[0]), bottomLeft[1], wrapLon(topRight[0]), topRight[1])
}


function onMapClick(evt){
    let coordinate = evt.coordinate;
    let hdms = ol.coordinate.toStringHDMS(coordinate);
    
    let coord4326 = transform([coordinate[0], coordinate[1]])
    if( mode == 'nearest_poi'){
        get_poi(coord4326[1], coord4326[0])
    }
}

function wrapLon(value) {
    var worlds = Math.floor((value + 180) / 360);
    return value - (worlds * 360);
}
$(".owl-carousel").owlCarousel({
    margin:10,
    loop:true,
    autoWidth:true,
    items:4
});
</script>


{% endblock script_end %}


